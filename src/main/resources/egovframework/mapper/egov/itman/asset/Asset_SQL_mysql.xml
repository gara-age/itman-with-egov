<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="assetDAO">
    <sql id="assetCondition">
        <where>
            A.DEL_YN = 'N'
            AND A.GRO_IDX = #{searching.groIdx}
            <if test="searching.searchKeyword != null and searching.searchKeyword != ''">
            <choose>
                <when test="searching.searchCondition == 'assUlid'">
                    AND A.ASS_ULID LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                </when>
                <when test="searching.searchCondition == 'assName'">
                    AND A.ASS_NAME LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                </when>
                <when test="searching.searchCondition == 'assCatName'">
                    AND C.ASS_CAT_NAME LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                </when>
                <otherwise>
                    AND (
                    A.ASS_ULID LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                    OR A.ASS_NAME LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                    OR C.ASS_CAT_NAME LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                    )
                </otherwise>
            </choose>
            </if>
        </where>
    </sql>
    <select id="selectAssetList" parameterType="pagination" resultType="assetVO">
    SELECT
        ROW_NUMBER() OVER(ORDER BY A.ASS_IDX ASC) AS rowNum,
        A.ASS_IDX AS assIdx,
        A.GRO_IDX AS groIdx,
        A.ASS_ULID AS assUlid,
        A.ASS_NAME AS assName,
        A.IMAGE AS image,
        C.ASS_CAT_NAME AS assCatName,
        S.STA_NAME AS assStaName,
        E.EMP_NAME AS assEmpName,
        L.LOC_NAME AS assLocName,
        SP.SUP_NAME AS assSupName,
        A.BUY_DATE AS buyDate,
        A.PRICE AS price
        FROM ITM_ASSET A
        LEFT JOIN ITM_ASSET_CATEGORY C ON C.ASS_CAT_IDX = A.ASS_CAT_IDX
        LEFT JOIN ITM_STATE S ON S.STA_IDX = A.STA_IDX
        LEFT JOIN ITM_EMPLOYE E ON E.EMP_IDX = A.EMP_IDX
        LEFT JOIN ITM_LOCATION L ON L.LOC_IDX = A.LOC_IDX
        LEFT JOIN ITM_SUPPLIER SP ON SP.SUP_IDX = A.SUP_IDX
        <include refid="assetCondition"/>
            LIMIT #{startList} , #{listSize}
    </select>

    <select id="selectEmpAssetList" parameterType="employeeVO" resultType="assetVO">
        SELECT
        A.ASS_IDX AS assIdx,
        A.GRO_IDX AS groIdx,
        A.ASS_ULID AS assUlid,
        A.ASS_NAME AS assName,
        A.IMAGE AS image,
        C.ASS_CAT_NAME AS assCatName,
        SP.SUP_NAME AS assSupName,
        A.BUY_DATE AS buyDate
        FROM ITM_ASSET A
        LEFT JOIN ITM_ASSET_CATEGORY C ON C.ASS_CAT_IDX = A.ASS_CAT_IDX
        LEFT JOIN ITM_STATE S ON S.STA_IDX = A.STA_IDX
        LEFT JOIN ITM_EMPLOYE E ON E.EMP_IDX = A.EMP_IDX
        LEFT JOIN ITM_LOCATION L ON L.LOC_IDX = A.LOC_IDX
        LEFT JOIN ITM_SUPPLIER SP ON SP.SUP_IDX = A.SUP_IDX
        WHERE
            A.DEL_YN = 'N'
            AND A.GRO_IDX = #{groIdx}
            AND A.EMP_IDX = #{empIdx}
    </select>

<select id="selectAssetListCnt" parameterType="pagination" resultType="int">
    SELECT
        COUNT(*)
    FROM
        ITM_ASSET A
    LEFT JOIN ITM_ASSET_CATEGORY C ON C.ASS_CAT_IDX = A.ASS_CAT_IDX
    <include refid="assetCondition"/>
</select>

    <select id="selectInGroupAssetListCnt" parameterType="pagination" resultType="int">
        SELECT
        COUNT(*) AS listCnt
        FROM
        ITM_ASSET A
        LEFT JOIN ITM_ASSET_CATEGORY C ON C.ASS_CAT_IDX = A.ASS_CAT_IDX
        WHERE A.GRO_IDX = #{searching.groIdx}
    </select>

    <select id="selectAssetView" parameterType="assetVO" resultType="assetVO">
        SELECT
            A.GRO_IDX AS groIdx,
            A.ASS_IDX AS assIdx,
            A.ASS_ULID AS assUlid,
            A.ASS_NAME AS assName,
            A.IMAGE AS image,
            A.ASS_CAT_IDX AS assCatIdx,
            C.ASS_CAT_NAME AS assCatName,
            A.REG_DATE AS regDate,
            A.STA_IDX AS staIdx,
            S.STA_NAME AS assStaName,
            A.LOC_IDX AS locIdx,
            L.LOC_NAME AS assLocName,
            E.EMP_NAME AS assEmpName,
            A.MOD_DATE AS modDate,
            SP.SUP_NAME AS assSupName,
            A.BUY_DATE AS buyDate,
            A.PRICE AS price
        FROM ITM_ASSET A
                 LEFT JOIN ITM_ASSET_CATEGORY C ON C.ASS_CAT_IDX = A.ASS_CAT_IDX
                 LEFT JOIN ITM_STATE S ON S.STA_IDX = A.STA_IDX
                 LEFT JOIN ITM_EMPLOYE E ON E.EMP_IDX = A.EMP_IDX
                 LEFT JOIN ITM_LOCATION L ON L.LOC_IDX = A.LOC_IDX
                 LEFT JOIN ITM_SUPPLIER SP ON SP.SUP_IDX = A.SUP_IDX
        WHERE
            A.ASS_IDX = ${assIdx}
    </select>

    <insert id="insertAsset" parameterType="assetVO" useGeneratedKeys="true" keyProperty="assIdx">
        INSERT INTO ITM_ASSET
        <trim prefix="(" suffix=")" suffixOverrides=",">
        GRO_IDX,
        ASS_ULID,
        ASS_NAME,
        ASS_CAT_IDX,
        STA_IDX,
        LOC_IDX,
        <if test="empIdx != null and empIdx.trim().length() > 0">EMP_IDX,</if>
        <if test="supIdx != null and supIdx.trim().length() > 0">SUP_IDX,</if>
        <if test="buyDate != null and buyDate.trim.length() > 0">BUY_DATE,</if>
        <if test="price != null and price.trim.length() > 0">PRICE,</if>
        REG_DATE,
        REG_IDX,
        <if test="image != null and image.trim.length() > 0">IMAGE,</if>
        </trim>
        VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
            #{groIdx},
            #{assUlid},
            #{assName},
            #{assCatIdx},
            #{staIdx},
            #{locIdx},
        <if test="empIdx != null and empIdx.trim().length() > 0">#{empIdx},</if>
        <if test="supIdx != null and supIdx.trim().length() > 0">#{supIdx},</if>
        <if test="buyDate != null and buyDate.trim.length() > 0">#{buyDate},</if>
        <if test="price != null and price.trim.length() > 0">#{price},</if>
            NOW(),
            #{regIdx},
        <if test="image != null and image.trim.length() > 0">#{image},</if>
        </trim>

    </insert>

    <update id="updateAssetNameInfo" parameterType="assetVO">
        UPDATE
            ITM_ASSET
        SET
            ASS_NAME = #{assName},
            MOD_DATE = NOW(),
            MOD_IDX = #{modIdx}
        WHERE
            ASS_IDX = #{assIdx}
    </update>

    <update id="updateAssetCategoryInfo" parameterType="assetVO">
        UPDATE
            ITM_ASSET
        SET
            ASS_CAT_IDX = #{assCatIdx},
            MOD_DATE = NOW(),
            MOD_IDX = #{modIdx}
        WHERE
            ASS_IDX = #{assIdx}
    </update>

    <update id="updateAssetStateInfo" parameterType="assetVO">
        UPDATE
            ITM_ASSET
        SET
            STA_IDX = #{staIdx},
            MOD_DATE = NOW(),
            MOD_IDX = #{modIdx}
        WHERE
            ASS_IDX = #{assIdx}
    </update>

    <update id="updateAssetLocationInfo" parameterType="assetVO">
        UPDATE
            ITM_ASSET
        SET
            LOC_IDX = #{locIdx},
            MOD_DATE = NOW()
        WHERE
            ASS_IDX = #{assIdx}
    </update>
    <update id="updateAssetEmployeeInfo" parameterType="assetVO">
        UPDATE
            ITM_ASSET
        SET
            EMP_IDX = #{empIdx},
            MOD_DATE = NOW(),
            MOD_IDX = #{modIdx}
        WHERE
            ASS_IDX = #{assIdx}
    </update>

    <update id="updateAssetSupplyInfo" parameterType="assetVO">
        UPDATE
            ITM_ASSET
        SET
            SUP_IDX = #{supIdx},
            MOD_DATE = NOW(),
            MOD_IDX = #{modIdx}
        WHERE
            ASS_IDX = #{assIdx}
    </update>

    <update id="updateAssetBuyDateInfo" parameterType="assetVO">
        UPDATE
            ITM_ASSET
        SET
            BUY_DATE = #{buyDate},
            MOD_DATE = NOW(),
            MOD_IDX = #{modIdx}
        WHERE
            ASS_IDX = #{assIdx}
    </update>
    <update id="updateAssetPriceInfo" parameterType="assetVO">
        UPDATE
            ITM_ASSET
        SET
            PRICE = #{price},
            MOD_DATE = NOW(),
            MOD_IDX = #{modIdx}
        WHERE
            ASS_IDX = #{assIdx}
    </update>

    <update id="updateAssetPictureInfo" parameterType="assetVO">
        UPDATE
            ITM_ASSET
        SET
            IMAGE = #{image},
            MOD_DATE = NOW(),
            MOD_IDX = #{modIdx}
        WHERE
            ASS_IDX = #{assIdx}
    </update>

    <update id="deleteAsset" parameterType="assetVO">
        UPDATE
            ITM_ASSET
        SET
            <trim suffixOverrides=",">
            DEL_YN = 'Y',
            MOD_IDX = #{modIdx}
            </trim>
        WHERE
            ASS_IDX = #{assIdx}
    </update>

</mapper>

